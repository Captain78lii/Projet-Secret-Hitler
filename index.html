<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - √âdition Interactive</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Courier+Prime:wght@400;700&family=Old+Standard+TT:wght@700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #101010; color: #ecf0f1; font-family: 'Courier Prime', monospace; overflow: hidden; user-select: none; }
        .font-title { font-family: 'Anton', sans-serif; }
        
        /* Animations */
        .vote-badge-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .announcement-enter { animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .timer-pulse { animation: pulse-red 1s infinite; }
        
        @keyframes startPulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .animate-start { animation: startPulse 2s infinite; }

        .perspective-1000 { perspective: 1000px; }
        .animate-shuffle { animation: shuffleMove 0.5s infinite linear; }
        @keyframes shuffleMove { 0% { transform: translateX(0) scale(1); z-index: 1; } 25% { transform: translateX(100px) scale(0.9); z-index: 0; } 50% { transform: translateX(0) scale(0.8); z-index: -1; } 75% { transform: translateX(-100px) scale(0.9); z-index: 0; } 100% { transform: translateX(0) scale(1); z-index: 1; } }
        .animate-drop-in { animation: dropInCard 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes dropInCard { 0% { transform: translateY(-500px) scale(0.1) rotate(720deg); opacity: 0; } 70% { transform: translateY(20px) scale(1.2) rotate(-10deg); opacity: 1; } 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; } }

        .newspaper { background: #fdf1d6; color: #1a1a1a; box-shadow: 0 0 50px rgba(0,0,0,0.9); transform: rotate(-1deg); }
        
        /* Scrollbar pour les r√®gles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTE API ---
        const API_KEY = ""; 

        // --- AUDIO ---
        const BACKGROUND_MUSIC_URL = "https://ia800300.us.archive.org/17/items/MetalGearSolidOriginalGameSoundtrack/20%20-%20Game%20Over.mp3";
        const SOUNDS = {
            flip: "https://www.myinstants.com/media/sounds/card-flip.mp3",
            smash: "https://www.myinstants.com/media/sounds/gavel.mp3",
            win_lib: "https://www.myinstants.com/media/sounds/final-fantasy-vii-victory-fanfare.mp3",
            win_fas: "https://www.myinstants.com/media/sounds/imperial_march.mp3",
            fail: "https://www.myinstants.com/media/sounds/wrong-answer-sound-effect.mp3",
            ding: "https://www.myinstants.com/media/sounds/ding-sound-effect_2.mp3",
            power_down: "https://www.myinstants.com/media/sounds/pacman-die.mp3",
            slide: "https://www.myinstants.com/media/sounds/card-shuffle.mp3"
        };

        class AudioManager {
            constructor() {
                this.sounds = {};
                this.isInitialized = false;
                this.bgm = null;
            }
            init() {
                if (this.isInitialized) return;
                this.bgm = new Audio(BACKGROUND_MUSIC_URL);
                this.bgm.loop = true;
                this.bgm.volume = 0.3;
                Object.keys(SOUNDS).forEach(key => {
                    const s = new Audio(SOUNDS[key]);
                    s.volume = 0.5; 
                    s.onerror = () => { this.sounds[key] = null; };
                    this.sounds[key] = s;
                });
                this.bgm.play().catch(e => {});
                this.isInitialized = true;
            }
            play(key) {
                if (!this.isInitialized) return;
                const sound = this.sounds[key];
                if (sound) {
                    try {
                        sound.currentTime = 0;
                        sound.volume = key.startsWith('win') ? 0.6 : 0.4;
                        sound.play().catch(e => {});
                    } catch (e) {}
                }
            }
        }
        const audioMgr = new AudioManager();

        // --- ICONS (VERSION ORIGINALE MAIS CORRIG√âE POUR EVITER LE CRASH) ---
        // J'utilise <g> (groupe) au lieu de React.Fragment (<>...</>) qui causait l'√©cran noir.
        const Icon = ({ path, color="currentColor", size=24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>
        );
        const Icons = {
            Bulb: () => <Icon color="#facc15" path={<path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/>} />,
            X: () => <Icon color="#ef4444" path={<path d="M18 6 6 18M6 6l12 12"/>} />,
            Book: () => <Icon path={<g><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></g>} />,
            Radio: () => <Icon path={<g><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/></g>} />,
            Sparkles: () => <Icon color="#facc15" path={<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/>} />
        };

        // --- DATA ---
        const COLORS = { Liberal: "#3498db", Fascist: "#e74c3c", Hitler: "#8e44ad", Alliance: "#27ae60", Sympathy: "#58d68d", Suspicion: "#e67e22", Conflict: "#c0392b" };
        const PROPAGANDA_LIB = ["La libert√© triomphe !", "D√©mocratie sauv√©e.", "Nouvelle √©cole ouverte.", "Presse libre !", "Raison victorieuse."];
        const PROPAGANDA_FAS = ["Ordre r√©tabli.", "Couvre-feu instaur√©.", "Opposition musel√©e.", "S√©curit√© nationale !", "Pouvoirs renforc√©s."];

        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        const getPlayerPosition = (index, total) => {
            const angle = (index / total) * 2 * Math.PI - Math.PI / 2;
            const radius = 260;
            return { x: Math.cos(angle) * radius, y: Math.sin(angle) * radius };
        };

        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) return null;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (e) { return null; }
        };

        const BackgroundMusic = () => {
            useEffect(() => {
                if (audioMgr.bgm) {
                    audioMgr.bgm.volume = 0.3;
                    if (audioMgr.bgm.paused) { audioMgr.bgm.play().catch(e => {}); }
                }
            }, []);
            return null;
        };

        // --- R√àGLES D√âTAILL√âES (COMPLETE ET RICHE) ---
        const RulesModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 fade-in">
                <div className="bg-gray-900 border-2 border-gray-600 rounded-lg max-w-5xl w-full max-h-[95vh] flex flex-col shadow-2xl text-gray-200">
                    {/* HEADER */}
                    <div className="p-6 border-b border-gray-700 flex justify-between items-center bg-gray-950 rounded-t-lg">
                        <h2 className="text-3xl font-title text-yellow-500 tracking-wider">R√àGLEMENT OFFICIEL D√âTAILL√â</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-white transition"><Icons.X /></button>
                    </div>
                    
                    {/* BODY */}
                    <div className="p-8 overflow-y-auto font-sans leading-relaxed text-sm md:text-base space-y-10">
                        
                        {/* INTRODUCTION */}
                        <div className="text-center italic text-gray-400 mb-6 border-b border-gray-800 pb-4">
                            "L'ann√©e est 1932. Le lieu est l'Allemagne d'avant-guerre. Les joueurs sont des politiciens allemands tentant de maintenir un gouvernement lib√©ral fragile ou d'installer un r√©gime fasciste."
                        </div>

                        {/* 1. OBJECTIFS & VICTOIRE */}
                        <section>
                            <h3 className="text-2xl font-bold text-white mb-4 border-l-4 border-yellow-500 pl-3">üèÜ 1. CONDITIONS DE VICTOIRE</h3>
                            <div className="grid md:grid-cols-2 gap-8">
                                <div className="bg-blue-900/20 p-6 rounded-lg border border-blue-800/50">
                                    <h4 className="font-bold text-blue-400 mb-3 text-xl border-b border-blue-800/30 pb-2">LES LIB√âRAUX (L'√âquipe Bleue)</h4>
                                    <p className="mb-3 text-sm text-gray-300">Les Lib√©raux sont majoritaires, mais ils ne savent pas qui est qui. Ils doivent apprendre √† se faire confiance.</p>
                                    <ul className="list-disc pl-5 space-y-2 text-gray-200">
                                        <li><strong>Option A :</strong> Faire passer <strong>5 lois Lib√©rales</strong> (Bleues).</li>
                                        <li><strong>Option B :</strong> Assassiner <strong>Hitler</strong> (via le pouvoir d'ex√©cution).</li>
                                    </ul>
                                </div>
                                <div className="bg-red-900/20 p-6 rounded-lg border border-red-800/50">
                                    <h4 className="font-bold text-red-500 mb-3 text-xl border-b border-red-800/30 pb-2">LES FASCISTES (L'√âquipe Rouge)</h4>
                                    <p className="mb-3 text-sm text-gray-300">Les Fascistes sont minoritaires, mais ils se connaissent et travaillent ensemble pour semer le chaos.</p>
                                    <ul className="list-disc pl-5 space-y-2 text-gray-200">
                                        <li><strong>Option A :</strong> Faire passer <strong>6 lois Fascistes</strong> (Rouges).</li>
                                        <li><strong>Option B :</strong> Faire √©lire <strong>Hitler</strong> au poste de Chancelier, MAIS seulement apr√®s que 3 lois Fascistes ont d√©j√† √©t√© vot√©es.</li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        {/* 2. D√âROULEMENT DU TOUR */}
                        <section>
                            <h3 className="text-2xl font-bold text-white mb-4 border-l-4 border-yellow-500 pl-3">üîÑ 2. D√âROULEMENT D'UN TOUR</h3>
                            <div className="space-y-6">
                                <div>
                                    <h4 className="font-bold text-yellow-100 text-lg mb-2">PHASE 1 : L'√âLECTION</h4>
                                    <ol className="list-decimal pl-5 text-gray-300 space-y-2">
                                        <li>Le titre de <strong>Pr√©sident</strong> passe au joueur suivant (sens des aiguilles d'une montre).</li>
                                        <li>Le nouveau Pr√©sident nomme un candidat au poste de <strong>Chancelier</strong>.</li>
                                        <li>Tous les joueurs (y compris les candidats) votent <span className="text-green-400 font-bold">JA!</span> ou <span className="text-red-400 font-bold">NEIN!</span>.</li>
                                        <li>Si le vote √©choue (√©galit√© ou majorit√© de NON) : Le titre de Pr√©sident passe au suivant, et le compteur de "Chaos" augmente.</li>
                                        <li>Si le vote r√©ussit (majorit√© de OUI) : Le gouvernement est √©lu et on passe √† la phase l√©gislative.</li>
                                    </ol>
                                </div>
                                
                                <div>
                                    <h4 className="font-bold text-yellow-100 text-lg mb-2">PHASE 2 : S√âANCE L√âGISLATIVE</h4>
                                    <ol className="list-decimal pl-5 text-gray-300 space-y-2">
                                        <li>Le Pr√©sident pioche <strong>3 cartes</strong> du paquet.</li>
                                        <li>Il en jette secr√®tement <strong>1</strong> et passe les <strong>2</strong> restantes au Chancelier.</li>
                                        <li>Le Chancelier re√ßoit 2 cartes, en jette secr√®tement <strong>1</strong>, et pose la derni√®re sur le plateau.</li>
                                    </ol>
                                    <p className="mt-2 text-sm text-gray-400 bg-gray-800 p-2 rounded"><em>Note importante : Les joueurs peuvent MENTIR sur les cartes qu'ils ont vues ou re√ßues. C'est le c≈ìur du jeu.</em></p>
                                </div>

                                <div>
                                    <h4 className="font-bold text-yellow-100 text-lg mb-2">PHASE 3 : POUVOIR EX√âCUTIF</h4>
                                    <p className="text-gray-300">Si une loi Fasciste est vot√©e et qu'elle recouvre une case marqu√©e d'un pouvoir, le Pr√©sident DOIT utiliser ce pouvoir imm√©diatement.</p>
                                </div>
                            </div>
                        </section>

                        {/* 3. POUVOIRS PR√âSIDENTIELS */}
                        <section>
                            <h3 className="text-2xl font-bold text-white mb-4 border-l-4 border-yellow-500 pl-3">‚ö° 3. POUVOIRS PR√âSIDENTIELS</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-gray-800 p-4 rounded flex items-start gap-4">
                                    <div className="text-3xl">üîç</div>
                                    <div>
                                        <strong className="text-yellow-400 block mb-1">INVESTIGATION</strong>
                                        <span className="text-sm text-gray-300">Le Pr√©sident choisit un joueur et regarde secr√®tement sa carte de parti (Lib√©ral ou Fasciste). Il ne voit pas si c'est Hitler, juste le camp.</span>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded flex items-start gap-4">
                                    <div className="text-3xl">üëî</div>
                                    <div>
                                        <strong className="text-yellow-400 block mb-1">√âLECTION SP√âCIALE</strong>
                                        <span className="text-sm text-gray-300">Le Pr√©sident choisit qui sera le prochain Pr√©sident (au lieu de suivre l'ordre du tour). Apr√®s ce tour sp√©cial, l'ordre normal reprend l√† o√π il s'√©tait arr√™t√©.</span>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded flex items-start gap-4">
                                    <div className="text-3xl">üëÄ</div>
                                    <div>
                                        <strong className="text-yellow-400 block mb-1">REGARD (POLICY PEEK)</strong>
                                        <span className="text-sm text-gray-300">Le Pr√©sident regarde secr√®tement les 3 prochaines cartes de la pioche. Utile pour savoir si le prochain gouvernement mentira.</span>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded flex items-start gap-4 border border-red-900">
                                    <div className="text-3xl">üî´</div>
                                    <div>
                                        <strong className="text-red-500 block mb-1">EX√âCUTION</strong>
                                        <span className="text-sm text-gray-300">Le Pr√©sident choisit un joueur √† ex√©cuter. Ce joueur est √©limin√© du jeu (ne vote plus, ne parle plus). <strong>Si Hitler est ex√©cut√©, les Lib√©raux gagnent imm√©diatement.</strong></span>
                                    </div>
                                </div>
                            </div>
                        </section>
                        {/* FOOTER MESSAGE */}
                        <div className="bg-yellow-900/20 p-4 rounded text-center text-gray-400 italic text-sm">
                            "La seule chose n√©cessaire au triomphe du mal est que les hommes de bien ne fassent rien."
                        </div>

                    </div>
                    {/* BUTTON */}
                    <div className="p-6 bg-gray-950 border-t border-gray-700 text-center rounded-b-lg">
                        <button onClick={onClose} className="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-4 px-16 rounded-full text-xl transition shadow-[0_0_20px_rgba(234,179,8,0.3)] hover:scale-105">J'AI COMPRIS, LANCER LA PARTIE</button>
                    </div>
                </div>
            </div>
        );

        const CardSVG = ({ role }) => {
            const c = role === 'Liberal' ? "#3498db" : (role === 'Fascist' ? "#e74c3c" : "#8e44ad");
            const t = role ? role[0] : "?";
            return (
                <svg viewBox="0 0 100 140" className="w-full h-full shadow-lg rounded border-2 border-white">
                    <rect width="100" height="140" fill={c}/>
                    <text x="50" y="70" textAnchor="middle" fill="white" fontSize="20" fontFamily="Anton">{t}</text>
                    <text x="50" y="100" textAnchor="middle" fill="white" fontSize="10" fontFamily="Courier">{role}</text>
                </svg>
            );
        };

        const TrustGraph = ({ players, trustMatrix, width, height, viewerId, mode }) => {
            const center = { x: width / 2, y: height / 2 };
            const getPos = (i) => getPlayerPosition(i, players.length);
            return (
                <svg className="absolute top-0 left-0 w-full h-full pointer-events-none" style={{zIndex: 5}}>
                    <defs>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                        </filter>
                        <marker id="arrow-head" markerWidth="6" markerHeight="6" refX="22" refY="3" orient="auto">
                            <path d="M0,0 L0,6 L9,3 z" fill="currentColor" />
                        </marker>
                    </defs>
                    {players.map((p1, i) => players.map((p2, j) => {
                        if (i === j) return null;
                        if (mode === "MULTI") return null;
                        if (mode === "SOLO" && viewerId === 0 && players[viewerId]?.role === "Liberal") {
                            const r1 = players[i].role; const r2 = players[j].role;
                            const isBad1 = r1 === "Fascist" || r1 === "Hitler"; const isBad2 = r2 === "Fascist" || r2 === "Hitler";
                            if (isBad1 && isBad2 && i !== 0 && j !== 0) return null;
                        }
                        if (mode === "SOLO" && i !== 0 && Math.abs(trustMatrix[i][j]) < 0.2) return null;
                        const trust = trustMatrix[i][j];
                        if (Math.abs(trust) < 0.1) return null;

                        const start = getPos(i); const end = getPos(j);
                        const sx = center.x + start.x; const sy = center.y + start.y;
                        const ex = center.x + end.x; const ey = center.y + end.y;
                        const mx = (sx + ex) / 2; const my = (sy + ey) / 2;
                        const dx = ex - sx; const dy = ey - sy;
                        const curvature = 0.25;
                        const cx = mx - dy * curvature; const cy = my + dx * curvature;

                        let color = "#7f8c8d";
                        if (trust > 0.5) color = COLORS.Alliance;
                        else if (trust > 0) color = COLORS.Sympathy;
                        else if (trust > -0.5) color = COLORS.Suspicion;
                        else color = COLORS.Conflict;

                        const strokeWidth = Math.max(2, Math.abs(trust) * 6);
                        const opacity = Math.min(0.3 + Math.abs(trust), 0.9);

                        return (
                            <g key={`${i}-${j}`}>
                                <path d={`M ${sx} ${sy} Q ${cx} ${cy} ${ex} ${ey}`} fill="none" stroke={color} strokeWidth={strokeWidth} strokeOpacity={opacity} markerEnd={`url(#arrow-${i}-${j})`} className="trust-line" filter="url(#glow)" style={{color: color}} />
                                <defs><marker id={`arrow-${i}-${j}`} markerWidth="6" markerHeight="6" refX="18" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill={color} fillOpacity={opacity} /></marker></defs>
                            </g>
                        );
                    }))}
                </svg>
            );
        };
        
        const PassScreen = ({ nextPlayerName, onReady }) => (
            <div className="pass-screen fade-in">
                <div className="text-white text-4xl font-title mb-8 tracking-widest">TOUR DE {nextPlayerName.toUpperCase()}</div>
                <button onClick={onReady} className="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 px-12 rounded-full text-2xl shadow-[0_0_30px_rgba(234,179,8,0.5)] transition transform hover:scale-105">JE SUIS {nextPlayerName}</button>
            </div>
        );

        const App = () => {
            const [mode, setMode] = useState("START");
            const [gameState, setGameState] = useState("INIT");
            const [players, setPlayers] = useState([]);
            const [trustMatrix, setTrustMatrix] = useState([]);
            const [deck, setDeck] = useState([]);
            const [hand, setHand] = useState([]);
            const [libPolicies, setLibPolicies] = useState(0);
            const [fasPolicies, setFasPolicies] = useState(0);
            const [presidentId, setPresidentId] = useState(null);
            const [chancellorId, setChancellorId] = useState(null);
            const [logs, setLogs] = useState(["Bienvenue."]);
            const [advice, setAdvice] = useState(null);
            const [showRules, setShowRules] = useState(false);
            const [activePlayerId, setActivePlayerId] = useState(null);
            const [showPassScreen, setShowPassScreen] = useState(false);
            const [multiVotes, setMultiVotes] = useState({});
            const [showMultiSetup, setShowMultiSetup] = useState(false);
            const [aiMessage, setAiMessage] = useState(null);
            const [endGameStory, setEndGameStory] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [chaosTracker, setChaosTracker] = useState(0);
            const [userApiKey, setUserApiKey] = useState(API_KEY);
            const [turnTimer, setTurnTimer] = useState(30);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [rouletteState, setRouletteState] = useState(null);
            const [revealedRole, setRevealedRole] = useState(null);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                if (gameState === "GAME_OVER_TIMEOUT") audioMgr.play("power_down");
                else if (gameState === "GAME_OVER_LIB") audioMgr.play("win_lib");
                else if (gameState === "GAME_OVER_FAS") audioMgr.play("win_fas");
            }, [gameState]);

            useEffect(() => {
                if (gameState.startsWith("GAME_OVER")) return;
                if (libPolicies >= 5) setGameState("GAME_OVER_LIB");
                if (fasPolicies >= 6) setGameState("GAME_OVER_FAS");
            }, [libPolicies, fasPolicies, gameState]);

            const initAudioAndEnter = () => {
                audioMgr.init();
                setMode("MENU");
            };

            const addLog = (msg) => setLogs(prev => [msg, ...prev]);

            const announce = (title, sub, details, onComplete, duration = 6000) => {
                setNotification({ title, sub, details });
                if (title.includes("GOUVERNEMENT")) audioMgr.play(title.includes("√âLU") ? "ding" : "fail");
                else if (title.includes("LOI")) audioMgr.play(title.includes("LIB√âRALE") ? "ding" : "smash");
                else audioMgr.play("flip");
                setTimeout(() => {
                    setNotification(null);
                    if(onComplete) onComplete();
                }, duration);
            };

            const updateTrust = (source, target, delta) => {
                setTrustMatrix(prev => {
                    const next = [...prev.map(r => [...r])];
                    next[source][target] = Math.max(-1, Math.min(1, next[source][target] + delta));
                    return next;
                });
            };

            const triggerAiNarration = async (policyType) => {
                setIsAiLoading(true);
                let text = null;
                if (userApiKey) {
                    const prompt = `Jeu Secret Hitler. Une loi ${policyType} vient d'√™tre vot√©e. R√©dige un flash info radio tr√®s court (max 15 mots) style propagande ann√©es 30.`;
                    text = await callGemini(prompt, userApiKey);
                }
                if (!text) {
                    const list = policyType === "Liberal" ? PROPAGANDA_LIB : PROPAGANDA_FAS;
                    text = list[Math.floor(Math.random() * list.length)];
                }
                setAiMessage({ type: "RADIO", text: text, icon: <Icons.Radio /> });
                setIsAiLoading(false);
            };

            const triggerAnalyst = async () => {
                if (!userApiKey) { alert("Cl√© manquante"); return; }
                setIsAiLoading(true);
                const context = logs.slice(0, 5).join("\n");
                const prompt = `Analyse ces logs de jeu : ${context}. Qui est suspect ? R√©ponds en 1 phrase.`;
                const text = await callGemini(prompt, userApiKey);
                setAiMessage({ type: "ANALYST", text: text, icon: <Icons.Sparkles /> });
                setIsAiLoading(false);
                audioMgr.play("ding");
            };

            const generateEndGameStory = async (winType) => {
                if (!userApiKey) return;
                const prompt = `Le jeu Secret Hitler vient de finir : ${winType}. √âcris un article de journal de 30 mots annon√ßant le r√©sultat historique.`;
                const text = await callGemini(prompt, userApiKey);
                setEndGameStory(text);
            };

            const nextTurn = () => {
                let next = (presidentId + 1) % players.length;
                while (!players[next].isAlive) next = (next + 1) % players.length;
                setPresidentId(next); setChancellorId(null); setHand([]);
                addLog(`------------------------------`);
                addLog(`NOUVEAU TOUR`);
                setPlayers(prev => prev.map(p => ({ ...p, lastVote: null })));
                if (mode === "MULTI") {
                    setActivePlayerId(next);
                    setShowPassScreen(true);
                }
                setGameState("NOMINATION");
            };

            const handleNomination = (targetId) => {
                // MODIF : Emp√™cher le clic en mode spectateur
                if (mode === "SPECTATOR" || !players[presidentId]?.isHuman) return;

                if (targetId === presidentId || !players[targetId].isAlive) return;
                announce("VOTRE CHOIX", `Vous proposez\n${players[targetId].name.toUpperCase()}\ncomme Chancelier`, "", () => {
                     setChancellorId(targetId);
                     addLog(`${players[presidentId].name} nomme ${players[targetId].name}.`);
                     audioMgr.play("smash");
                     if (mode === "MULTI") {
                        setMultiVotes({});
                        setGameState("MULTI_VOTE");
                        setActivePlayerId(0);
                        setShowPassScreen(true);
                     } else {
                        setGameState("VOTE");
                     }
                }, 4000);
            };

            const handleEnact = (idx) => {
                const card = hand[idx];
                let suspicionText = "";
                
                if (mode !== "MULTI") {
                     let hasSuspicion = false;
                     players.forEach(observer => {
                         if (!observer.isAlive || hasSuspicion) return;
                         [presidentId, chancellorId].forEach(targetId => {
                             if (observer.id === targetId) return;
                             let delta = 0;
                             if (observer.role === "Liberal") { if (card === "Fascist") delta = -0.3; }
                             if (delta < 0 && observer.id !== 0) {
                                  if (Math.random() > 0.6) {
                                      suspicionText = `${observer.name} regarde ${players[targetId].name} avec m√©fiance...`;
                                      hasSuspicion = true;
                                  }
                             }
                         });
                     });
                }

                announce(`LOI ${card.toUpperCase()}`, "PROMULGU√âE !", suspicionText, () => {
                     triggerAiNarration(card);
                     
                     let updatedLib = libPolicies;
                     let updatedFas = fasPolicies;

                     if (card === "Liberal") {
                         updatedLib = libPolicies + 1;
                         addLog(`üïäÔ∏è Une loi LIB√âRALE est promulgu√©e ! (${updatedLib}/5)`);
                         setLibPolicies(updatedLib);
                     } else {
                         updatedFas = fasPolicies + 1;
                         addLog(`üêç Une loi FASCISTE est promulgu√©e ! (${updatedFas}/6)`);
                         setFasPolicies(updatedFas);
                     }
                     
                     const liberalWin = updatedLib >= 5;
                     const fascistWin = updatedFas >= 6;

                     if (liberalWin) {
                         setGameState("GAME_OVER_LIB");
                         generateEndGameStory("VICTOIRE LIB√âRALE");
                     } else if (fascistWin) {
                         setGameState("GAME_OVER_FAS");
                         generateEndGameStory("VICTOIRE FASCISTE");
                     } else {
                         if (mode !== "MULTI") {
                             players.forEach(observer => {
                                 if (!observer.isAlive) return;
                                 [presidentId, chancellorId].forEach(targetId => {
                                     if (observer.id === targetId) return;
                                     let delta = 0;
                                     if (observer.role === "Liberal") { if (card === "Fascist") delta = -0.3; else delta = 0.2; } else { if (card === "Fascist") delta = 0.2; else delta = -0.15; }
                                     updateTrust(observer.id, targetId, delta);
                                 });
                             });
                         }
                         nextTurn();
                     }
                }, 5000);
            };

            const handleDiscard = (idx) => {
                const newHand = [...hand];
                newHand.splice(idx, 1);
                setHand(newHand);
                audioMgr.play("flip");
                addLog(`Le Pr√©sident passe 2 cartes au Chancelier.`);
                if (mode === "MULTI") {
                    setActivePlayerId(chancellorId);
                    setShowPassScreen(true);
                }
                setGameState("LEG_CHAN");
            };

            // --- CORRECTION CRITIQUE DU BUG "6 CARTES" (RESHUFFLE) ---
            const startLegislation = () => {
                let workingDeck = [...deck];
                if (workingDeck.length < 3) {
                    addLog("Rem√©lange du deck (D√©fausse + Reste)...");
                    let newDeck = Array(6 - libPolicies).fill("Liberal").concat(Array(11 - fasPolicies).fill("Fascist"));
                    workingDeck = shuffleArray(newDeck);
                }
                const draw = workingDeck.slice(0, 3);
                const remaining = workingDeck.slice(3);
                setDeck(remaining);
                setHand(draw);
                if (mode === "MULTI") {
                     setActivePlayerId(presidentId);
                     setShowPassScreen(true);
                }
                setGameState("LEG_PRES");
            };

            const resolveVotes = (votesMap) => {
                const voteValues = Object.values(votesMap);
                const jas = voteValues.filter(v => v === "JA").length;
                const total = voteValues.length;
                setPlayers(prev => prev.map(p => ({ ...p, lastVote: votesMap[p.id] })));

                const passed = jas > total/2;
                const title = passed ? "GOUVERNEMENT √âLU" : "GOUVERNEMENT REJET√â";
                const sub = `${jas} JA - ${total-jas} NEIN`;
                const neinVoters = Object.keys(votesMap).filter(id => votesMap[id] === "NEIN").map(id => players[id].name).join(", ");
                const details = neinVoters.length > 0 ? `Contre: ${neinVoters}` : "Unanimit√© pour le OUI";
                
                announce(title, sub, details, () => {
                     addLog(`Vote : ${jas} JA - ${total-jas} NEIN.`);
                     if (passed) {
                         if (fasPolicies >= 3 && players[chancellorId].role === "Hitler") {
                             setGameState("GAME_OVER_FAS");
                             generateEndGameStory("VICTOIRE FASCISTE (Hitler √âlu)");
                             return;
                         }
                         startLegislation();
                     } else {
                         setChaosTracker(c => {
                             const newVal = c + 1;
                             if(newVal >= 3) {
                                 addLog("Chaos ! Une loi est forc√©e.");
                                 const forcedCard = Math.random() > 0.6 ? "Fascist" : "Liberal";
                                 if(forcedCard === "Liberal") setLibPolicies(prev => prev + 1);
                                 else setFasPolicies(prev => prev + 1);
                                 return 0; 
                             }
                             return newVal;
                         });
                         addLog("Le gouvernement est rejet√© ! Chaos imminent.");
                         nextTurn();
                     }
                }, 6000);
            };

            const simulateSpectatorVotes = () => {
                const votesMap = {};
                players.forEach(p => {
                    if(!p.isAlive) return;
                    const trustPres = trustMatrix[p.id][presidentId];
                    const trustChan = trustMatrix[p.id][chancellorId];
                    const score = (trustPres + trustChan) / 2;
                    const bias = (p.role !== 'Liberal') ? 0.3 : 0;
                    votesMap[p.id] = (score + bias > -0.2) ? "JA" : "NEIN";
                });
                resolveVotes(votesMap);
            };

            const handleVote = (vote) => {
                if (mode === "MULTI") {
                    const newVotes = {...multiVotes, [activePlayerId]: vote};
                    setMultiVotes(newVotes);
                    let nextVoter = activePlayerId + 1;
                    while (nextVoter < players.length && !players[nextVoter].isAlive) nextVoter++;
                    if (nextVoter < players.length) {
                         setActivePlayerId(nextVoter);
                         setShowPassScreen(true);
                    }
                    else resolveVotes(newVotes);
                } else {
                    const votesMap = {};
                    players.forEach(p => {
                        if(!p.isAlive) return;
                        if(p.id === 0 && mode === "SOLO") votesMap[p.id] = vote;
                        else {
                            const trustPres = trustMatrix[p.id][presidentId];
                            const trustChan = trustMatrix[p.id][chancellorId];
                            const score = (trustPres + trustChan) / 2;
                            const bias = (p.role !== 'Liberal') ? 0.3 : 0;
                            votesMap[p.id] = (score + bias > -0.2) ? "JA" : "NEIN";
                        }
                    });
                    resolveVotes(votesMap);
                }
            };
            
            const getAdvice = () => {
                const myRole = players[0].role;
                if (myRole === "Liberal") {
                    if (fasPolicies >= 3) return "DANGER : Ne votez OUI que si vous √™tes s√ªr du Chancelier. Si Hitler est √©lu, c'est perdu.";
                    if (libPolicies >= 4) return "La victoire est proche ! Cherchez un gouvernement qui a d√©j√† prouv√© sa loyaut√©.";
                    return "Observez qui vote 'NON' aux gouvernements corrects.";
                } else if (myRole === "Fascist") {
                    if (fasPolicies < 3) return "Jouez comme un Lib√©ral pour gagner leur confiance.";
                    return "C'est le moment ! Essayez de nommer Hitler chancelier.";
                } else {
                    if (fasPolicies >= 3) return "Les Fascistes savent qui vous √™tes. Faites-vous √©lire Chancelier !";
                    return "Faites profil bas. Votez comme la majorit√©.";
                }
            };

            const handleSoloStart = () => {
                setMode("ROLE_ROULETTE");
                setRouletteState("SPINNING");
                audioMgr.play("slide");
                const baseRoles = ["Liberal", "Liberal", "Liberal", "Liberal", "Fascist", "Fascist", "Hitler"];
                const shuffled = shuffleArray([...baseRoles]);
                const myRole = shuffled[0];
                setRevealedRole(myRole);
                setTimeout(() => {
                    setRouletteState("REVEALED");
                    audioMgr.play("win_lib");
                }, 3000);
            };

            const confirmSoloRole = () => {
                 audioMgr.play("ding");
                 startGame("SOLO", revealedRole, 7);
            };

            const startGame = (gameMode, assignedRole = null, playerCount = 7) => {
                let roles = [];
                if (gameMode === "SOLO") {
                    const baseRoles = ["Liberal", "Liberal", "Liberal", "Liberal", "Fascist", "Fascist", "Hitler"];
                    const pool = [...baseRoles];
                    const idx = pool.indexOf(assignedRole);
                    if (idx > -1) pool.splice(idx, 1);
                    const shuffledPool = shuffleArray(pool);
                    roles = [assignedRole, ...shuffledPool];
                    playerCount = 7;
                } else {
                    let liberals = 0; let fascists = 0;
                    switch(playerCount) {
                        case 5: liberals = 3; fascists = 1; break;
                        case 6: liberals = 4; fascists = 1; break;
                        case 7: liberals = 4; fascists = 2; break;
                        case 8: liberals = 5; fascists = 2; break;
                        case 9: liberals = 5; fascists = 3; break;
                        case 10: liberals = 6; fascists = 3; break;
                        default: liberals = 4; fascists = 2;
                    }
                    let rolesPool = Array(liberals).fill("Liberal").concat(Array(fascists).fill("Fascist")).concat(["Hitler"]);
                    roles = shuffleArray(rolesPool);
                }
                const newPlayers = roles.map((r, i) => ({
                    id: i, 
                    name: gameMode === "SOLO" && i === 0 ? "MOI" : `Joueur ${i + 1}`, 
                    role: r, 
                    isAlive: true, 
                    // MODIF : En SPECTATEUR, tout le monde est 'Bot' (isHuman: false), m√™me le joueur 0
                    isHuman: gameMode === "MULTI" || (gameMode === "SOLO" && i === 0), 
                    lastVote: null
                }));
                const matrix = Array(playerCount).fill(0).map(() => Array(playerCount).fill(0));
                newPlayers.forEach((p1, i) => {
                    newPlayers.forEach((p2, j) => {
                        if (i===j) return;
                        if (p1.role === 'Fascist' && (p2.role === 'Fascist' || p2.role === 'Hitler')) matrix[i][j] = 0.8;
                        if (playerCount <= 6) { if (p1.role === 'Hitler' && p2.role === 'Fascist') matrix[i][j] = 0.8; }
                    });
                });
                setPlayers(newPlayers);
                setTrustMatrix(matrix);
                let initialDeck = Array(6).fill("Liberal").concat(Array(11).fill("Fascist"));
                setDeck(shuffleArray(initialDeck));
                setLibPolicies(0); setFasPolicies(0); setChaosTracker(0);
                setEndGameStory(null);
                setMode(gameMode);
                setPresidentId(0);
                setActivePlayerId(0);
                setLogs(["D√©but de la partie."]);
                setShowMultiSetup(false);
                if (gameMode === "MULTI") { setShowPassScreen(true); setGameState("ROLE_REVEAL"); } else { setGameState("NOMINATION"); audioMgr.play("smash"); }
            };
            
            useEffect(() => {
                if (gameState === "GAME_OVER" || mode === "MENU" || mode === "ROLE_REVEAL" || mode === "SPECTATOR" || mode === "MULTI" || mode === "ROLE_ROULETTE" || notification || mode === "START") {
                    setIsTimerRunning(false); return;
                }
                let isHumanTurn = false;
                if (gameState === "NOMINATION" && presidentId === 0) isHumanTurn = true;
                if (gameState === "VOTE" && players[0].isAlive && !players[0].lastVote) isHumanTurn = true;
                if (gameState === "LEG_PRES" && presidentId === 0) isHumanTurn = true;
                if (gameState === "LEG_CHAN" && chancellorId === 0) isHumanTurn = true;
                if (isHumanTurn) { setTurnTimer(30); setIsTimerRunning(true); } else { setIsTimerRunning(false); }
            }, [gameState, presidentId, chancellorId, mode, players, notification]);

            useEffect(() => {
                let interval;
                if (isTimerRunning && turnTimer > 0) { interval = setInterval(() => { setTurnTimer(prev => prev - 1); }, 1000); }
                else if (isTimerRunning && turnTimer === 0) { handleTimeout(); }
                return () => clearInterval(interval);
            }, [isTimerRunning, turnTimer]);

            const handleTimeout = () => {
                setIsTimerRunning(false);
                setGameState("GAME_OVER_TIMEOUT");
                audioMgr.play("power_down");
            };

            useEffect(() => {
                if (gameState.startsWith("GAME_OVER") || mode === "MULTI" || mode === "ROLE_ROULETTE" || notification || mode === "START") return;

                const botTurn = async () => {
                    const isPresBot = players[presidentId] && !players[presidentId].isHuman;
                    const isChanBot = players[chancellorId] && !players[chancellorId].isHuman;

                    if (gameState === "NOMINATION" && isPresBot) {
                        await new Promise(r => setTimeout(r, 4000));
                        let eligible = players.filter(p => p.id !== presidentId && p.isAlive);
                        let choice = eligible[Math.floor(Math.random() * eligible.length)];
                        announce("NOMINATION", `${players[presidentId].name} propose\n${choice.name.toUpperCase()}\ncomme Chancelier`, "", () => {
                             setChancellorId(choice.id); addLog(`${players[presidentId].name} propose ${choice.name} comme Chancelier.`); audioMgr.play("smash"); setGameState("VOTE");
                        }, 5000);
                    }
                    else if (gameState === "VOTE" && (mode === "SPECTATOR" || !players[0].lastVote)) { 
                        // MODIF: Si spectateur, on d√©clenche les votes automatiques
                        if (mode === "SPECTATOR") {
                             await new Promise(r => setTimeout(r, 4000)); 
                             simulateSpectatorVotes(); 
                        }
                    }
                    else if (gameState === "LEG_PRES" && isPresBot) { await new Promise(r => setTimeout(r, 4000)); handleDiscard(0); }
                    else if (gameState === "LEG_CHAN" && isChanBot) { await new Promise(r => setTimeout(r, 4000)); const bot = players[chancellorId]; let pick = 0; if (bot.role === 'Liberal' && hand.includes('Liberal')) pick = hand.indexOf('Liberal'); else if (bot.role !== 'Liberal' && hand.includes('Fascist')) pick = hand.indexOf('Fascist'); handleEnact(pick); }
                };
                botTurn();
            }, [gameState, presidentId, chancellorId, hand, mode, notification, players, trustMatrix]);

            if (mode === "START") {
                return (
                    <div className="flex h-screen flex-col items-center justify-center bg-black text-white gap-10">
                        {/* Zone Cliquable pour lancer */}
                        <div onClick={initAudioAndEnter} className="text-center cursor-pointer animate-start group">
                            <h1 className="text-6xl font-title text-red-600 mb-4 group-hover:scale-105 transition-transform">SECRET HITLER</h1>
                            <p className="text-2xl group-hover:text-red-400 transition-colors">CLIQUEZ POUR LANCER L'EXP√âRIENCE</p>
                            <p className="text-sm text-gray-500 mt-4">(Activation Audio Requise)</p>
                        </div>

                        {/* Zone Input Cl√© API (Non cliquable pour le start) */}
                        <div className="flex flex-col items-center gap-3 z-50 p-4 rounded-lg bg-gray-900/50 border border-gray-800" onClick={e => e.stopPropagation()}>
                            <div className="flex flex-col items-center">
                                <label className="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Cl√© API Gemini (Optionnel)</label>
                                <input 
                                    type="text" 
                                    value={userApiKey}
                                    onChange={(e) => setUserApiKey(e.target.value)}
                                    placeholder="Collez votre cl√© ici..." 
                                    className="bg-black border border-gray-600 text-yellow-500 text-center text-sm px-4 py-2 rounded w-64 focus:border-yellow-500 focus:outline-none transition-colors"
                                />
                            </div>
                            <p className="text-[9px] text-gray-500 max-w-[250px] text-center">
                                Laissez vide pour jouer normalement. Avec une cl√©, l'IA g√©n√®re des r√©cits uniques.
                            </p>
                        </div>
                    </div>
                );
            }

            if (mode === "MENU") {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-gray-900 text-white font-mono gap-6 p-4">
                        <BackgroundMusic />
                        <button onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); setShowRules(true); }} className="absolute top-4 right-4 text-gray-400 hover:text-white flex items-center gap-2 transition"><Icons.Book size={20} /> <span>R√®gles</span></button>
                        {showRules && <RulesModal onClose={() => { audioMgr.play('flip'); setShowRules(false); }} />}
                        {showMultiSetup && (
                            <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center fade-in">
                                <div className="bg-gray-800 p-8 rounded-lg border-2 border-green-500 text-center shadow-[0_0_30px_rgba(34,197,94,0.3)]">
                                    <h2 className="text-3xl font-title text-green-500 mb-6">CONFIGURATION MULTI</h2>
                                    <p className="mb-6 text-gray-300">Combien de joueurs autour de la table ?</p>
                                    <div className="grid grid-cols-3 gap-4 mb-8">
                                        {[5, 6, 7, 8, 9, 10].map(num => (
                                            <button key={num} onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); startGame("MULTI", null, num); }}
                                                className="bg-gray-700 hover:bg-green-600 text-white font-bold py-4 px-6 rounded text-xl border border-gray-600 transition transform hover:scale-105"
                                            >{num}</button>
                                        ))}
                                    </div>
                                    <button onClick={() => { audioMgr.play('flip'); setShowMultiSetup(false); }} className="text-gray-500 hover:text-white underline transition">Annuler</button>
                                </div>
                            </div>
                        )}
                        <h1 className="text-7xl font-title text-red-600 tracking-widest uppercase mb-4 drop-shadow-lg">Secret Hitler</h1>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
                            <div className="bg-gray-800 p-6 rounded-lg border-2 border-gray-700 hover:border-blue-500 transition cursor-pointer group" onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); handleSoloStart(); }}>
                                <div className="text-4xl mb-4">üë§</div>
                                <h3 className="text-xl font-bold mb-2">JOUER SOLO</h3>
                                <p className="text-xs text-gray-400">R√¥le al√©atoire. 6 Bots.</p>
                            </div>
                            <div className="bg-gray-800 p-6 rounded-lg border-2 border-gray-700 hover:border-yellow-500 transition cursor-pointer group" onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); startGame("SPECTATOR"); }}>
                                <div className="text-4xl mb-4">üëÅÔ∏è</div>
                                <h3 className="text-xl font-bold mb-2">SPECTATEUR</h3>
                                <p className="text-xs text-gray-400">Regardez les bots jouer.</p>
                            </div>
                             <div className="bg-gray-800 p-6 rounded-lg border-2 border-gray-700 hover:border-green-500 transition cursor-pointer group" onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); setShowMultiSetup(true); }}>
                                <div className="text-4xl mb-4">üë•</div>
                                <h3 className="text-xl font-bold mb-2">MULTI LOCAL</h3>
                                <p className="text-xs text-gray-400">Passez l'appareil.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (mode === "ROLE_ROULETTE") {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-gray-900 text-white overflow-hidden relative">
                         <BackgroundMusic />
                         <div className="text-4xl font-title mb-10 text-yellow-500 tracking-widest">D√âTERMINATION DU R√îLE</div>
                         <div className="flex gap-8 perspective-1000">
                             {["Liberal", "Fascist", "Hitler"].map((r, i) => (
                                 <div key={i} className={`w-32 h-48 bg-gray-700 rounded-lg border-4 border-white shadow-2xl flex items-center justify-center text-4xl transform transition-all duration-500 ${rouletteState === 'SPINNING' ? 'animate-shuffle' : (r === revealedRole ? 'scale-110 z-50 animate-drop-in' : 'opacity-20 scale-75 blur-sm')}`}>
                                             {rouletteState === 'SPINNING' ? '‚ùì' : (r === revealedRole ? (r === 'Liberal' ? 'üïäÔ∏è' : (r === 'Hitler' ? 'üëø' : 'üêç')) : '')}
                                 </div>
                             ))}
                         </div>
                         {rouletteState === 'REVEALED' && (
                             <div className="mt-12 text-center animate-fade-in">
                                 <div className="text-2xl mb-4">VOUS √äTES : <span className={`font-bold ${revealedRole === 'Liberal' ? 'text-blue-500' : 'text-red-500'}`}>{revealedRole.toUpperCase()}</span></div>
                                 <button onClick={confirmSoloRole} className="bg-white text-black font-bold py-3 px-8 rounded hover:scale-105 transition shadow-[0_0_20px_white]">COMMENCER LA PARTIE</button>
                             </div>
                         )}
                    </div>
                );
            }

            if (showPassScreen && mode === "MULTI") return <PassScreen nextPlayerName={players[activePlayerId].name} onReady={() => setShowPassScreen(false)} />;
            
            if (gameState === "ROLE_REVEAL" && mode === "MULTI") {
                 return (
                    <div className="flex flex-col items-center justify-center h-screen bg-gray-900 text-white">
                        <BackgroundMusic />
                        <div className="flex flex-col items-center">
                            <h2 className="text-3xl text-yellow-500 mb-4 font-title uppercase">Identit√© Secr√®te</h2>
                            <div className="w-48 h-64 mb-6 transition-all duration-500 transform hover:scale-105">
                                 <CardSVG role={players[activePlayerId].role} />
                            </div>
                            <p className="text-gray-400 mb-6 max-w-md text-center">
                                {players[activePlayerId].role === "Liberal" ? "Vous √™tes un Lib√©ral. Trouvez la v√©rit√©." : "Vous √™tes un Fasciste. Semez le chaos."}
                            </p>
                            <button onClick={() => {
                                audioMgr.play('ding');
                                if (gameState === "ROLE_REVEAL") {
                                    if (activePlayerId < players.length - 1) {
                                         setActivePlayerId(activePlayerId + 1);
                                         setShowPassScreen(true);
                                    }
                                    else {
                                         setGameState("NOMINATION");
                                         setActivePlayerId(0);
                                         setShowPassScreen(false);
                                         addLog("La partie commence !");
                                         audioMgr.play("smash");
                                    }
                                }
                            }} className="bg-white text-black font-bold py-3 px-8 rounded hover:bg-gray-200">
                                CONFIRMER & SUIVANT
                            </button>
                        </div>
                    </div>
                 );
            }

            if (gameState === "MULTI_VOTE" && mode === "MULTI") {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-gray-900 text-white p-8">
                          <BackgroundMusic />
                          <h2 className="text-3xl font-title text-yellow-500 mb-8">{players[activePlayerId].name}, votez !</h2>
                          <div className="flex gap-8">
                             <button onClick={() => { audioMgr.play('ding'); handleVote("JA"); }} className="bg-green-600 w-32 h-32 rounded-lg text-2xl font-bold">JA!</button>
                             <button onClick={() => { audioMgr.play('ding'); handleVote("NEIN"); }} className="bg-red-600 w-32 h-32 rounded-lg text-2xl font-bold">NEIN!</button>
                          </div>
                    </div>
                );
            }

            if(gameState.startsWith("GAME_OVER")) {
                const isLibWin = gameState==="GAME_OVER_LIB";
                const isTimeout = gameState === "GAME_OVER_TIMEOUT";
                const bgColor = isLibWin ? "bg-blue-900" : (isTimeout ? "bg-gray-900" : "bg-red-900");
                
                return (
                    <div className={`flex flex-col items-center justify-center h-screen ${bgColor} text-white animate-pulse relative`}>
                        {endGameStory && !isTimeout && (
                            <div className="absolute top-10 newspaper p-6 max-w-lg text-black animate-fade-in z-50 bg-[#f4e4bc] border shadow-xl transform -rotate-1 text-center">
                                <div className="newspaper-header text-4xl mb-4 font-newspaper border-b-4 border-black pb-2">THE DAILY TRUTH</div>
                                <div className="text-justify font-serif text-lg leading-relaxed whitespace-pre-line">{endGameStory}</div>
                            </div>
                        )}

                        <h1 className="text-8xl font-title mb-4 mt-32 drop-shadow-lg text-center">
                            {isTimeout ? "MORT D'IND√âCISION" : (isLibWin ? "VICTOIRE LIB√âRALE" : "VICTOIRE FASCISTE")}
                        </h1>
                        {isTimeout && <p className="text-2xl text-gray-400 mb-8">Vous avez pris trop de temps √† jouer.</p>}
                        
                        <button onClick={() => window.location.reload()} className="px-8 py-4 bg-white text-black font-bold rounded hover:scale-110 transition shadow-xl text-xl mt-8">Nouvelle Partie</button>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-gray-950 text-gray-200 overflow-hidden font-sans">
                    <BackgroundMusic />
                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                    
                    {notification && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 pointer-events-none fade-in">
                            <div className="bg-gray-900 border-4 border-white p-8 rounded-xl text-center shadow-2xl max-w-2xl transform scale-110 announcement-enter">
                                 <h2 className="text-4xl font-title text-yellow-500 mb-4">{notification.title}</h2>
                                 <div className="text-2xl text-white font-serif whitespace-pre-line leading-relaxed mb-4">
                                    {notification.sub}
                                 </div>
                                 {notification.details && (
                                    <div className="text-sm text-gray-400 italic">
                                         {notification.details}
                                    </div>
                                 )}
                            </div>
                        </div>
                    )}
                    
                    {/* LEFT PANEL */}
                    <div className="w-[30%] flex flex-col border-r border-gray-800 bg-[#121212] p-4 gap-4 shadow-2xl relative z-20 overflow-y-auto">
                        <div className="space-y-4">
                            <div className="bg-gray-800 p-3 rounded-lg border-2 border-blue-800 shadow-md">
                                <h3 className="text-blue-400 font-title text-xl text-center mb-2 tracking-widest">LIBERALISM</h3>
                                <div className="flex gap-1 justify-center">
                                    {[...Array(5)].map((_, i) => <div key={i} className={`w-10 h-14 rounded border flex items-center justify-center transition-all duration-500 ${i < libPolicies ? 'bg-blue-500 border-blue-300 scale-105 shadow-blue-500/50 shadow-lg' : 'bg-gray-900 border-dashed border-gray-700'}`}>{i < libPolicies && "üïäÔ∏è"}</div>)}
                                </div>
                            </div>
                            <div className="bg-gray-800 p-3 rounded-lg border-2 border-red-900 shadow-md">
                                <h3 className="text-red-500 font-title text-xl text-center mb-2 tracking-widest">FASCISM</h3>
                                <div className="flex gap-1 justify-center">
                                    {[...Array(6)].map((_, i) => <div key={i} className={`w-10 h-14 rounded border flex items-center justify-center relative transition-all duration-500 ${i < fasPolicies ? 'bg-red-600 border-red-300 scale-105 shadow-red-600/50 shadow-lg' : 'bg-gray-900 border-dashed border-gray-700'}`}>{i < fasPolicies ? "üêç" : <span className="text-[9px] text-gray-600 font-bold">{i>=2 ? (i===5?"WIN":"PWR") : ""}</span>}</div>)}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col justify-end">
                            <div className="bg-gray-900/80 p-4 rounded-xl border border-gray-600 mb-4 min-h-[180px] flex flex-col justify-center items-center text-center relative">
                                {isTimerRunning && (
                                    <div className="absolute top-2 right-2 flex items-center justify-center w-10 h-10 rounded-full border-2 border-red-500 text-red-500 font-bold text-lg timer-pulse">
                                        {turnTimer}
                                    </div>
                                )}
                               
                                <div className="mb-4 font-bold text-yellow-400 uppercase tracking-wide">
                                    {mode==="SPECTATOR" ? "OBSERVATION" : (players[activePlayerId]?.id === players[0].id || mode==="MULTI" ? "√Ä VOUS DE JOUER" : "TOUR ADVERSE")}
                                </div>
                                {mode !== "MULTI" && (
                                    <div className="flex justify-center gap-4 flex-wrap w-full">
                                            {gameState === "VOTE" && mode === "SOLO" && (
                                                <>
                                                    <button onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); handleVote("JA"); }} className="bg-green-600 px-6 py-2 rounded text-white font-bold transition transform hover:scale-105">JA!</button>
                                                    <button onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); handleVote("NEIN"); }} className="bg-red-600 px-6 py-2 rounded text-white font-bold transition transform hover:scale-105">NEIN!</button>
                                                </>
                                            )}
                                            {/* MODIF : Ajout de la v√©rification isHuman pour n'afficher les cartes QUE si c'est un humain */}
                                            {gameState === "LEG_PRES" && players[presidentId]?.isHuman && hand.map((c, i) => (
                                                <div key={i} onMouseEnter={() => audioMgr.play('flip')} onClick={() => handleDiscard(i)} className={`cursor-pointer w-16 h-24 rounded border flex items-center justify-center hover:-translate-y-2 transition ${c==='Liberal'?'bg-blue-600':'bg-red-700'}`}>{c==="Liberal"?"üïäÔ∏è":"üêç"}</div>
                                            ))}
                                            {gameState === "LEG_CHAN" && players[chancellorId]?.isHuman && hand.map((c, i) => (
                                                <div key={i} onMouseEnter={() => audioMgr.play('flip')} onClick={() => handleEnact(i)} className={`cursor-pointer w-16 h-24 rounded border flex items-center justify-center hover:-translate-y-2 transition ${c==='Liberal'?'bg-blue-600':'bg-red-700'}`}>{c==="Liberal"?"üïäÔ∏è":"üêç"}</div>
                                            ))}
                                    </div>
                                )}
                                {mode === "MULTI" && gameState.startsWith("LEG") && (
                                     <div className="flex justify-center gap-4">
                                         {hand.map((c, i) => (
                                             <div key={i} onClick={() => gameState==="LEG_PRES" ? handleDiscard(i) : handleEnact(i)} className={`cursor-pointer w-20 h-32 rounded border-2 flex flex-col items-center justify-center shadow-2xl ${c==='Liberal'?'bg-blue-600':'bg-red-700'}`}>
                                                 <div className="text-2xl mb-1">{c==="Liberal"?"üïäÔ∏è":"üêç"}</div>
                                                 <div className="text-[10px] font-bold uppercase">{c}</div>
                                             </div>
                                         ))}
                                     </div>
                                )}
                            </div>
                           
                            <div className="h-40 mt-4 overflow-y-auto text-xs font-mono text-gray-400 bg-black/50 p-2 rounded border border-gray-700">
                                {logs.map((l, i) => <div key={i} className="border-b border-gray-800 pb-1 mb-1">> {l}</div>)}
                            </div>
                        </div>
                    </div>

                    {/* MAIN VISUAL AREA */}
                    <div className="w-[70%] relative bg-[#181818] flex items-center justify-center overflow-hidden">
                        <div className="absolute top-4 right-4 flex gap-4 items-start z-30">
                            {mode !== "SPECTATOR" && (
                                <div className="bg-black/60 px-4 py-2 rounded-xl border border-gray-700 flex items-center gap-4">
                                    <div className="text-right">
                                        <div className="text-[10px] uppercase text-gray-400">VOTRE R√îLE</div>
                                        <div className={`text-xl font-bold font-title ${players[activePlayerId]?.role==='Liberal'?'text-blue-400':'text-red-500'}`}>{players[activePlayerId]?.role.toUpperCase()}</div>
                                    </div>
                                    <div className="w-8 h-12 rounded border border-gray-500 overflow-hidden"><CardSVG role={players[activePlayerId]?.role} /></div>
                                </div>
                            )}
                            <div className="flex flex-col gap-2">
                                <button onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); setAdvice(getAdvice()); }} className="bg-yellow-600/90 p-3 rounded-full hover:bg-yellow-500 text-white shadow-lg" title="Conseil"><Icons.Bulb /></button>
                                <button onMouseEnter={() => audioMgr.play('flip')} onClick={() => { audioMgr.play('ding'); triggerAnalyst(); }} className="bg-purple-600/90 p-3 rounded-full hover:bg-purple-500 text-white shadow-lg" title="Analyser"><Icons.Sparkles /></button>
                            </div>
                        </div>
                        
                        {aiMessage && (
                            <div className="absolute top-24 right-4 bg-yellow-900/90 text-yellow-100 p-4 rounded-lg border border-yellow-500 shadow-2xl max-w-sm advice-toast z-50">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-yellow-400 flex items-center gap-2">
                                        {aiMessage.icon}
                                        {aiMessage.type === 'RADIO' ? 'FLASH INFO' : 'CONSEIL'}
                                    </h4>
                                    <button onClick={() => setAiMessage(null)}><Icons.X size={16}/></button>
                                </div>
                                <p className="text-sm italic">{aiMessage.text}</p>
                            </div>
                        )}
                        
                        {advice && !aiMessage && (
                            <div className="absolute top-24 right-4 bg-yellow-900/90 text-yellow-100 p-4 rounded-lg border border-yellow-500 shadow-2xl max-w-sm advice-toast z-50">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-yellow-400 flex items-center gap-2"><Icons.Sparkles size={16}/> CONSEIL</h4>
                                    <button onClick={() => setAdvice(null)}><Icons.X size={16}/></button>
                                </div>
                                <p className="text-sm italic">{advice}</p>
                            </div>
                        )}

                        <div className="relative w-[600px] h-[600px]">
                            {mode !== "MULTI" && <TrustGraph players={players} trustMatrix={trustMatrix} width={600} height={600} viewerId={mode==="SOLO"?0:null} mode={mode} />}
                            <div className="absolute inset-0 m-auto w-[450px] h-[450px] rounded-full border-[20px] border-[#2c2c2c] bg-[#1f1f1f] shadow-2xl flex items-center justify-center">
                                <div className="text-gray-700 font-title text-4xl opacity-20 tracking-[1em]">SECRET</div>
                            </div>
                            {players.map((p, i) => {
                                const pos = getPlayerPosition(i, players.length);
                                const left = 300 + pos.x - 40;
                                const top = 300 + pos.y - 40;
                                let showRole = false;
                                if (mode === "SPECTATOR") showRole = true;
                                else if (mode === "SOLO") {
                                    if (i === 0) showRole = true;
                                    if (players[0].role === 'Fascist' && (p.role !== 'Liberal')) showRole = true;
                                    if (players[0].role === 'Hitler' && p.role === 'Fascist' && players.length <= 6) showRole = true;
                                    if (!p.isAlive) showRole = true;
                                } else {
                                    if (p.id === activePlayerId) showRole = true;
                                }
                                
                                // MODIF : isTarget n'est vrai que si c'est le tour d'un humain (sinon pas de clic)
                                const isHumanTurn = players[presidentId]?.isHuman;
                                const isTarget = (gameState === "NOMINATION" && presidentId === activePlayerId && i !== activePlayerId && p.isAlive && isHumanTurn && mode !== "SPECTATOR");

                                return (
                                    <div key={i} onClick={() => { if(isTarget) { audioMgr.play('ding'); handleNomination(p.id); } }} className={`absolute w-24 flex flex-col items-center z-20 transition ${isTarget ? "cursor-pointer hover:scale-110 brightness-125" : ""}`} style={{left, top}}>
                                        <div className={`w-16 h-16 rounded-full border-4 flex items-center justify-center text-3xl shadow-lg bg-gray-800 ${showRole ? (p.role==='Liberal'?'border-blue-500':(p.role==='Hitler'?'border-purple-500':'border-red-500')) : 'border-gray-500'}`}>
                                            {p.isAlive ? (showRole ? (p.role==='Liberal'?"üïäÔ∏è":p.role==='Hitler'?"üëø":"üêç") : "üë§") : "üíÄ"}
                                        </div>
                                        {presidentId === i && <span className="absolute -top-3 bg-yellow-500 text-black text-[10px] px-1 rounded font-bold shadow-lg animate-bounce">PRES</span>}
                                        {chancellorId === i && <span className="absolute -bottom-3 bg-orange-500 text-black text-[10px] px-1 rounded font-bold shadow-lg animate-bounce">CHAN</span>}
                                        <span className="text-xs font-bold text-gray-400 mt-1 bg-black/60 px-2 rounded">{p.name}</span>
                                        {/* Vote Badge */}
                                        <div className={`absolute -right-3 -top-2 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border-2 shadow-lg z-50 vote-badge-enter ${p.lastVote ? (p.lastVote === "JA" ? "bg-green-600 border-green-400 text-white" : "bg-red-600 border-red-400 text-white") : "hidden"}`}>
                                            {p.lastVote}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
